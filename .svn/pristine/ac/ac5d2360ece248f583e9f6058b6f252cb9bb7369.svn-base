"use strict";var _createClass=function(){function t(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,s,e){return s&&t(i.prototype,s),e&&t(i,e),i}}();function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var Mention=function(){function t(i){_classCallCheck(this,t),this.options=i.options||[],this.input=i.input,this.reverse=i.reverse,this.symbol=i.symbol||"@",this.cursorPosition=0,this.hover=0,this.showingOptions=!1,this.upDownStay=0,this.wordAtCursor={},this.update=i.update||function(){},this.match=i.match||this.match,this.template=i.template||this.template,this.startsWith=i.startsWith||this.startsWith,this.html={input:void 0,display:void 0,wrapper:void 0,optionsList:void 0,options:[],spans:[]},this.setupHTML(),this.listen()}return _createClass(t,[{key:"match",value:function(t,i){return(i.name||i).toLowerCase()==t.toLowerCase()}},{key:"startsWith",value:function(t,i){return(i.name||i).toLowerCase().startsWith(t.toLowerCase())}},{key:"template",value:function(t){return t.name||t}},{key:"setupHTML",value:function(){this.html.input=this.input,this.html.wrapper=document.createElement("div"),this.html.wrapper.classList.add("mention-wrapper"),this.html.input.parentElement.insertBefore(this.html.wrapper,this.html.input),this.html.wrapper.appendChild(this.html.input),this.html.optionsList=document.createElement("div"),this.html.optionsList.classList.add("mention-options"),this.html.wrapper.appendChild(this.html.optionsList),this.reverse&&(this.html.optionsList.classList.add("mention-options-reverse"),this.html.wrapper.insertBefore(this.html.optionsList,this.html.wrapper.firstChild));var t=!0,i=!1,s=void 0;try{for(var e,n=this.options[Symbol.iterator]();!(t=(e=n.next()).done);t=!0){var o=e.value,r=document.createElement("div");r.classList.add("mention-option"),r.innerHTML=this.template(o),r.setAttribute("mentiondata",JSON.stringify(o)),this.html.options.push(r),this.html.optionsList.appendChild(r)}}catch(t){i=!0,s=t}finally{try{!t&&n.return&&n.return()}finally{if(i)throw s}}}},{key:"listen",value:function(){var t=this;this.html.input.addEventListener("input",function(){t.onEventInput()}),this.html.input.addEventListener("keydown",function(i){t.onEventKeyDown(i)}),this.html.input.addEventListener("keyup",function(i){t.onEventKeyUp(i)}),this.html.options.forEach(function(i){i.addEventListener("click",function(i){t.onEventOptionClick(i.target)})})}},{key:"onEventInput",value:function(){this.update()}},{key:"onEventKeyDown",value:function(t){if(this.upDownStay=40==t.keyCode?1:38==t.keyCode?-1:0,this.reverse&&(this.upDownStay*=-1),this.upDownStay&&this.showingOptions&&t.preventDefault(),13==t.keyCode&&this.showingOptions){t.preventDefault();var i=this.html.options.find(function(t){return t.classList.contains("hover")});i&&this.onEventOptionClick(i)}}},{key:"onEventKeyUp",value:function(){this.cursorPositionChanged(),this.setHoverOption()}},{key:"onEventOptionClick",value:function(t){var i=this.symbol+JSON.parse(t.getAttribute("mentiondata")).name+" ",s=this.html.input.value.split("");s.splice(this.wordAtCursor.index,this.wordAtCursor.word.length,i),this.html.input.value=s.join(""),this.html.input.focus(),this.setCursorPosition(this.wordAtCursor.index+i.length+1),this.toggleOptionList(!1),this.update()}},{key:"cursorPositionChanged",value:function(){this.cursorPosition=this.html.input.selectionStart,this.wordAtCursor=this.readWordAtCursor({cursorPosition:this.cursorPosition,value:this.input.value}),this.toggleOptionList(this.wordAtCursor.word.length&&this.wordAtCursor.word[0]==this.symbol),this.showHideOptions()}},{key:"toggleOptionList",value:function(t){this.html.optionsList.classList.remove("show"),t&&this.html.optionsList.classList.add("show"),this.showingOptions=t}},{key:"showHideOptions",value:function(){for(var t in this.options){var i=this.wordAtCursor.word.replace(this.symbol,"");this.html.options[t].classList.remove("show"),this.startsWith(i,this.options[t])&&this.html.options[t].classList.add("show")}}},{key:"setHoverOption",value:function(){var t=this.html.options.filter(function(t){return t.classList.remove("hover"),t.classList.contains("show")});t.length?(this.hover=this.upDownStay?this.hover+this.upDownStay:0,this.hover<0&&(this.hover=t.length-1),this.hover==t.length&&(this.hover=0),t[this.hover].classList.add("hover")):this.toggleOptionList(!1)}},{key:"setCursorPosition",value:function(t){this.cursorPosition=t,this.html.input.setSelectionRange(t,t)}},{key:"readWordAtCursor",value:function(t){for(var i="",s=t.cursorPosition,e=t.value.replace(/\n/g," ");s--;){if(" "==e[s]||s<0)break}for(;s++<e.length-1;){var n=e[s];if(" "==n)break;i+=n}return{index:Math.max(s-i.length,0),word:i}}},{key:"findMatches",value:function(){var t=this.html.input.value.split("").concat([" "]),i=[],s="";for(var e in t){var n=t[e],o=t[e-1]||" ",r=[" ","\\n"].indexOf(o)>-1||10==o.charCodeAt(0);(n==this.symbol&&r||s.length)&&" "!=n&&(s+=n),s.length&&" "==n&&(i.push({word:s,index:Math.max(e-s.length,0)}),s="")}return i}},{key:"collect",value:function(){var t=this;return this.findMatches().filter(function(i){return t.options.some(function(s){return t.match(i.word.replace(t.symbol,""),s)})})}}]),t}();"undefined"!=typeof module&&(module.exports=Mention);